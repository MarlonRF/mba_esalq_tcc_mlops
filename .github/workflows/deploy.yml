name: CD - Deploy GCP

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      environment:
        description: "Deployment environment"
        required: true
        default: "production"
        type: choice
        options:
          - staging
          - production
      compat_legado:
        description: "Compatibilidade de campos legados (1=ativo, 0=inativo)"
        required: true
        default: "1"
        type: choice
        options:
          - "1"
          - "0"

env:
  PYTHON_VERSION: "3.11"
  PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  SERVICE_NAME: conforto-termico-api
  REGION: us-central1
  IMAGE_BASE: gcr.io/${{ secrets.GCP_PROJECT_ID }}/conforto-api

jobs:
  pre-deploy-checks:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install uv
        run: |
          curl -LsSf https://astral.sh/uv/install.sh | sh
          echo "$HOME/.local/bin" >> "$GITHUB_PATH"

      - name: Install dependencies
        run: uv sync --extra test

      - name: Run critical tests (without ClearML)
        run: |
          mkdir -p relatorios
          uv run python -m pytest tests/unit -m "not clearml" --disable-warnings

      - name: Build API image
        run: docker build -t conforto-api:predeploy -f src/api/Dockerfile src/api

      - name: Upload reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: relatorios-predeploy
          path: relatorios/**
          if-no-files-found: warn

  deploy:
    runs-on: ubuntu-latest
    needs: pre-deploy-checks
    permissions:
      contents: read
      id-token: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Authenticate in Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_CREDENTIALS }}

      - name: Setup gcloud
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.PROJECT_ID }}

      - name: Configure Docker auth
        run: gcloud auth configure-docker gcr.io --quiet

      - name: Build and push image
        run: |
          docker build -t ${{ env.IMAGE_BASE }}:${{ github.sha }} -t ${{ env.IMAGE_BASE }}:latest -f src/api/Dockerfile src/api
          docker push ${{ env.IMAGE_BASE }}:${{ github.sha }}
          docker push ${{ env.IMAGE_BASE }}:latest

      - name: Definir modo de compatibilidade legado
        run: |
          echo "COMPAT_LEGADO=${{ github.event.inputs.compat_legado || '1' }}" >> "$GITHUB_ENV"

      - name: Deploy Cloud Run
        run: |
          gcloud run deploy ${{ env.SERVICE_NAME }} \
            --image ${{ env.IMAGE_BASE }}:${{ github.sha }} \
            --region ${{ env.REGION }} \
            --platform managed \
            --allow-unauthenticated \
            --port=8080 \
            --memory=512Mi \
            --cpu=1 \
            --min-instances=0 \
            --max-instances=5 \
            --concurrency=80 \
            --set-env-vars=ENVIRONMENT=${{ github.event.inputs.environment || 'production' }},API_COMPAT_LEGADO_ATIVA=${COMPAT_LEGADO},API_DATA_LIMITE_LEGADO=2026-06-30

      - name: Health check
        run: |
          URL=$(gcloud run services describe ${{ env.SERVICE_NAME }} --region ${{ env.REGION }} --format 'value(status.url)')
          sleep 15
          curl -fsS "$URL/health" >/dev/null
          echo "Deploy healthy at: $URL"
