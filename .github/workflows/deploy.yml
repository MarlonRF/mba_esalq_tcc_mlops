name: CD - Deploy GCP

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      environment:
        description: "Deployment environment"
        required: true
        default: "production"
        type: choice
        options:
          - staging
          - production
      compat_legado:
        description: "Compatibilidade de campos legados (1=ativo, 0=inativo)"
        required: true
        default: "1"
        type: choice
        options:
          - "1"
          - "0"
      modo_corte_legado:
        description: "Modo de corte de legado (1 remove campos legados)"
        required: true
        default: "0"
        type: choice
        options:
          - "0"
          - "1"
      modo_teste_sem_gcp:
        description: "Executa validacao de CD sem autenticar/deploy no GCP (1=sim, 0=nao)"
        required: true
        default: "0"
        type: choice
        options:
          - "0"
          - "1"
      confirmacao_producao:
        description: "Confirmacao explicita para deploy em production (sim/nao)"
        required: true
        default: "nao"
        type: choice
        options:
          - "nao"
          - "sim"

env:
  PYTHON_VERSION: "3.11"
  PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  SERVICE_NAME: conforto-termico-api
  REGION: us-central1
  IMAGE_BASE: gcr.io/${{ secrets.GCP_PROJECT_ID }}/conforto-api

concurrency:
  group: cd-${{ github.workflow }}-${{ github.ref_name }}-${{ github.event.inputs.environment || 'staging' }}
  cancel-in-progress: false

jobs:
  pre-deploy-checks:
    runs-on: ubuntu-latest
    timeout-minutes: 25
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install uv
        run: |
          curl -LsSf https://astral.sh/uv/install.sh | sh
          echo "$HOME/.local/bin" >> "$GITHUB_PATH"

      - name: Install dependencies
        run: uv sync --extra test

      - name: Run critical tests (without ClearML)
        run: |
          mkdir -p relatorios
          uv run python -m pytest tests/unit -m "not clearml" --disable-warnings

      - name: Build API image
        run: docker build -t conforto-api:predeploy -f src/api/Dockerfile src/api

      - name: Upload reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: relatorios-predeploy
          path: relatorios/**
          if-no-files-found: warn

  deploy:
    runs-on: ubuntu-latest
    needs: pre-deploy-checks
    timeout-minutes: 25
    environment: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.environment || 'staging' }}
    permissions:
      contents: read
      id-token: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Definir contexto de deploy
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "AMBIENTE_IMPLANTACAO=${{ github.event.inputs.environment }}" >> "$GITHUB_ENV"
            echo "COMPAT_LEGADO=${{ github.event.inputs.compat_legado || '1' }}" >> "$GITHUB_ENV"
            echo "MODO_CORTE_LEGADO=${{ github.event.inputs.modo_corte_legado || '0' }}" >> "$GITHUB_ENV"
            echo "MODO_TESTE_SEM_GCP=${{ github.event.inputs.modo_teste_sem_gcp || '0' }}" >> "$GITHUB_ENV"
            echo "CONFIRMACAO_PRODUCAO=${{ github.event.inputs.confirmacao_producao || 'nao' }}" >> "$GITHUB_ENV"
          else
            echo "AMBIENTE_IMPLANTACAO=staging" >> "$GITHUB_ENV"
            echo "COMPAT_LEGADO=1" >> "$GITHUB_ENV"
            echo "MODO_CORTE_LEGADO=0" >> "$GITHUB_ENV"
            echo "MODO_TESTE_SEM_GCP=0" >> "$GITHUB_ENV"
            echo "CONFIRMACAO_PRODUCAO=nao" >> "$GITHUB_ENV"
          fi

      - name: Bloquear production fora da main
        run: |
          if [ "$AMBIENTE_IMPLANTACAO" = "production" ] && [ "${GITHUB_REF_NAME}" != "main" ]; then
            echo "Deploy production bloqueado: rode apenas a partir da branch main. Branch atual: ${GITHUB_REF_NAME}"
            exit 1
          fi
          if [ "$AMBIENTE_IMPLANTACAO" = "production" ] && [ "$CONFIRMACAO_PRODUCAO" != "sim" ]; then
            echo "Deploy production bloqueado: para confirmar, rode o workflow com confirmacao_producao=sim."
            exit 1
          fi

      - name: Validar pre-requisitos GCP
        if: ${{ env.MODO_TESTE_SEM_GCP != '1' }}
        run: |
          if [ -z "${{ secrets.GCP_PROJECT_ID }}" ]; then
            echo "Secret ausente: GCP_PROJECT_ID"
            exit 1
          fi
          if [ -z "${{ secrets.GCP_CREDENTIALS }}" ]; then
            echo "Secret ausente: GCP_CREDENTIALS"
            exit 1
          fi

      - name: Authenticate in Google Cloud
        if: ${{ env.MODO_TESTE_SEM_GCP != '1' }}
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_CREDENTIALS }}

      - name: Setup gcloud
        if: ${{ env.MODO_TESTE_SEM_GCP != '1' }}
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.PROJECT_ID }}

      - name: Configure Docker auth
        if: ${{ env.MODO_TESTE_SEM_GCP != '1' }}
        run: gcloud auth configure-docker gcr.io --quiet

      - name: Build and push image
        if: ${{ env.MODO_TESTE_SEM_GCP != '1' }}
        run: |
          docker build -t ${{ env.IMAGE_BASE }}:${{ github.sha }} -t ${{ env.IMAGE_BASE }}:latest -f src/api/Dockerfile src/api
          docker push ${{ env.IMAGE_BASE }}:${{ github.sha }}
          docker push ${{ env.IMAGE_BASE }}:latest

      - name: Definir servico de deploy
        if: ${{ env.MODO_TESTE_SEM_GCP != '1' }}
        run: |
          if [ "$AMBIENTE_IMPLANTACAO" = "staging" ]; then
            echo "SERVICO_IMPLANTACAO=${SERVICE_NAME}-staging" >> "$GITHUB_ENV"
          else
            echo "SERVICO_IMPLANTACAO=${SERVICE_NAME}" >> "$GITHUB_ENV"
          fi

      - name: Deploy Cloud Run
        if: ${{ env.MODO_TESTE_SEM_GCP != '1' }}
        run: |
          gcloud run deploy ${SERVICO_IMPLANTACAO} \
            --image ${{ env.IMAGE_BASE }}:${{ github.sha }} \
            --region ${{ env.REGION }} \
            --platform managed \
            --allow-unauthenticated \
            --port=8080 \
            --memory=512Mi \
            --cpu=1 \
            --min-instances=0 \
            --max-instances=5 \
            --concurrency=80 \
            --set-env-vars=ENVIRONMENT=${AMBIENTE_IMPLANTACAO},API_COMPAT_LEGADO_ATIVA=${COMPAT_LEGADO},API_MODO_CORTE_LEGADO=${MODO_CORTE_LEGADO},API_DATA_LIMITE_LEGADO=2026-06-30

      - name: Health check
        if: ${{ env.MODO_TESTE_SEM_GCP != '1' }}
        run: |
          URL=$(gcloud run services describe ${SERVICO_IMPLANTACAO} --region ${{ env.REGION }} --format 'value(status.url)')
          sleep 15
          curl -fsS "$URL/health" >/dev/null
          echo "Deploy healthy at: $URL"

      - name: Smoke contrato apos deploy
        if: ${{ env.MODO_TESTE_SEM_GCP != '1' }}
        run: |
          URL=$(gcloud run services describe ${SERVICO_IMPLANTACAO} --region ${{ env.REGION }} --format 'value(status.url)')
          export URL
          python - <<'PY'
          import json
          import os
          import urllib.request

          url_base = os.environ["URL"]
          corpo = json.dumps({
              "idade_anos": 30,
              "peso_kg": 70.0,
              "altura_cm": 175,
              "sexo_biologico": "m",
              "temperatura_media_c": 25.0,
              "umidade_relativa_percent": 60.0,
              "radiacao_solar_media_wm2": 400.0
          }).encode("utf-8")

          req = urllib.request.Request(
              f"{url_base}/predict",
              data=corpo,
              headers={"Content-Type": "application/json"},
              method="POST",
          )
          with urllib.request.urlopen(req) as resp:
              dados = json.loads(resp.read().decode("utf-8"))
              if "predicao" not in dados:
                  raise SystemExit("Contrato invalido: campo predicao ausente")
              if resp.headers.get("X-Compatibilidade-Legado") not in {"ativa", "inativa"}:
                  raise SystemExit("Cabecalho X-Compatibilidade-Legado invalido")
              if resp.headers.get("X-Modo-Corte-Legado") not in {"ativo", "inativo"}:
                  raise SystemExit("Cabecalho X-Modo-Corte-Legado invalido")
          PY

      - name: Teste local de CD (sem GCP)
        if: ${{ env.MODO_TESTE_SEM_GCP == '1' }}
        run: |
          docker build -t conforto-api:cd-teste -f src/api/Dockerfile src/api
          docker run -d --name conforto-api-cd -p 8080:8080 conforto-api:cd-teste
          for i in $(seq 1 30); do
            if curl -sf http://localhost:8080/health >/dev/null; then
              break
            fi
            sleep 1
            if [ "$i" -eq 30 ]; then
              echo "Falha no health check local"
              docker logs conforto-api-cd || true
              exit 1
            fi
          done
          curl -sf -X POST http://localhost:8080/predict \
            -H "Content-Type: application/json" \
            -d '{
              "idade_anos": 30,
              "peso_kg": 70.0,
              "altura_cm": 175,
              "sexo_biologico": "m",
              "temperatura_media_c": 25.0,
              "umidade_relativa_percent": 60.0,
              "radiacao_solar_media_wm2": 400.0
            }' >/dev/null

      - name: Encerrar container local de teste
        if: ${{ always() && env.MODO_TESTE_SEM_GCP == '1' }}
        run: |
          docker stop conforto-api-cd || true
          docker rm conforto-api-cd || true
