# Workflow de Deploy Condicional para Google Cloud Platform
# Este workflow s√≥ executa deploy se todos os testes passarem

name: CD - Deploy para GCP

on:
  push:
    branches: [ main ]  # Deploy autom√°tico s√≥ na main
  workflow_dispatch:  # Permite trigger manual
    inputs:
      environment:
        description: 'Ambiente de deploy (staging/production)'
        required: true
        default: 'staging'
        type: choice
        options:
        - staging
        - production

env:
  PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  SERVICE_NAME: conforto-termico-api
  REGION: us-central1
  
jobs:
  # Job 1: Executar todos os testes antes do deploy
  pre-deploy-tests:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout do c√≥digo
      uses: actions/checkout@v4
      
    - name: Configurar Python 3.11
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: Instalar uv
      run: python -m pip install --upgrade pip uv

    - name: Instalar depend√™ncias com uv
      run: |
        uv sync --all-extras --dev
        
    - name: Executar suite completa de testes
      run: |
        uv run pytest tests/ -v --tb=short \
          --cov=funcoes --cov=api \
          --cov-fail-under=20 \
          -m "not clearml"  # Pular testes que requerem ClearML
          
    - name: Verificar sintaxe dos arquivos Python
      run: |
        uv run python -m py_compile funcoes/*.py
        uv run python -m py_compile api/*.py
        
  # Job 2: Build e Deploy condicional
  deploy:
    runs-on: ubuntu-latest
    needs: pre-deploy-tests  # S√≥ roda se testes passarem
    if: success()  # Garante que s√≥ deploye se tudo passou
    
    steps:
    - name: Checkout do c√≥digo  
      uses: actions/checkout@v4
      
    - name: Configurar Google Cloud SDK
      uses: google-github-actions/setup-gcloud@v1
      with:
        project_id: ${{ env.PROJECT_ID }}
        service_account_key: ${{ secrets.GCP_SA_KEY }}
        export_default_credentials: true
        
    - name: Configurar Docker para GCR
      run: gcloud auth configure-docker
      
    - name: Build da imagem Docker
      run: |
        docker build -f src/api/Dockerfile -t gcr.io/${{ env.PROJECT_ID }}/${{ env.SERVICE_NAME }}:${{ github.sha }} .
        docker build -f src/api/Dockerfile -t gcr.io/${{ env.PROJECT_ID }}/${{ env.SERVICE_NAME }}:latest .
        
    - name: Push da imagem para GCR
      run: |
        docker push gcr.io/${{ env.PROJECT_ID }}/${{ env.SERVICE_NAME }}:${{ github.sha }}
        docker push gcr.io/${{ env.PROJECT_ID }}/${{ env.SERVICE_NAME }}:latest
        
    - name: Deploy para Cloud Run
      run: |
        gcloud run deploy ${{ env.SERVICE_NAME }} \
          --image gcr.io/${{ env.PROJECT_ID }}/${{ env.SERVICE_NAME }}:${{ github.sha }} \
          --platform managed \
          --region ${{ env.REGION }} \
          --allow-unauthenticated \
          --set-env-vars="ENVIRONMENT=${{ github.event.inputs.environment || 'production' }}" \
          --memory=1Gi \
          --cpu=1 \
          --min-instances=0 \
          --max-instances=10
          
    - name: Obter URL do servi√ßo deployado
      id: deploy-url
      run: |
        URL=$(gcloud run services describe ${{ env.SERVICE_NAME }} \
          --platform managed --region ${{ env.REGION }} \
          --format 'value(status.url)')
        echo "url=$URL" >> $GITHUB_OUTPUT
        echo "‚úÖ Deploy conclu√≠do: $URL"
        
    - name: Teste de sa√∫de p√≥s-deploy
      run: |
        URL="${{ steps.deploy-url.outputs.url }}"
        echo "Testando endpoint de sa√∫de: $URL/"
        
        # Aguardar 30 segundos para o servi√ßo ficar dispon√≠vel
        sleep 30
        
        # Testar endpoint b√°sico
        response=$(curl -s -o /dev/null -w "%{http_code}" "$URL/")
        if [ $response -eq 200 ]; then
          echo "‚úÖ Teste de sa√∫de passou: HTTP $response"
        else
          echo "‚ùå Teste de sa√∫de falhou: HTTP $response"
          exit 1
        fi
        
    - name: Notificar sucesso
      if: success()
      run: |
        echo "üöÄ Deploy realizado com sucesso!"
        echo "URL: ${{ steps.deploy-url.outputs.url }}"
        echo "Vers√£o: ${{ github.sha }}"
        
    - name: Rollback em caso de falha
      if: failure()
      run: |
        echo "‚ùå Deploy falhou. Iniciando rollback..."
        # Aqui voc√™ pode implementar l√≥gica de rollback
        # Por exemplo, deployar a vers√£o anterior
        gcloud run services update-traffic ${{ env.SERVICE_NAME }} \
          --to-revisions=LATEST=100 \
          --platform managed \
          --region ${{ env.REGION }}
        echo "üîÑ Rollback conclu√≠do"